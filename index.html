<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Land</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/cloudinary-core@2.11.4/cloudinary-core-shrinkwrap.min.js"></script>
  <script src="https://ad.gigapub.tech/script?id=1872"></script>
  <style>
    :root {
      --primary-color: #ffd700;
      --accent-color: #ffdb4d;
      --dark-bg: #0a0a0a;
      --card-bg: linear-gradient(145deg, #111, #1a1a1a);
      --header-bg: rgba(17, 17, 17, 0.95);
    }
    
    body {
      background: var(--dark-bg);
      color: var(--primary-color);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding-top: 70px;
      padding-bottom: 85px;
      min-height: 100vh;
    }
    
    /* TOP HEADER BAR */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      padding: 12px 20px;
      border-bottom: 1px solid #333;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* PERFECT BOTTOM NAV BAR */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      padding: 8px 10px;
      border-top: 1px solid #333;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
    }
    
    .bottom-nav a {
      color: rgba(255, 215, 0, 0.7);
      font-size: 22px;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 10px 14px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      position: relative;
      width: 100%;
      max-width: 72px;
    }
    
    .bottom-nav a.active {
      color: #fff;
      transform: translateY(-8px);
      text-shadow: 0 0 12px rgba(255, 215, 0, 0.9);
      background: rgba(255, 215, 0, 0.15);
    }
    
    .bottom-nav a span {
      font-size: 10px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      bottom: -4px;
    }
    
    .bottom-nav a.active span {
      opacity: 1;
      transform: translateY(10px);
    }
    
    /* SMOOTH ANIMATIONS */
    .card, .btn-custom, .progress-bar {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .card {
      background: var(--card-bg);
      border: none;
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(255, 215, 0, 0.15);
      color: var(--primary-color);
      overflow: hidden;
    }
    
    .btn-custom {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: #000;
      font-weight: 600;
      border-radius: 14px;
      padding: 12px 24px;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
      border: none;
      letter-spacing: 0.5px;
    }
    
    .btn-custom:hover {
      background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(255, 215, 0, 0.3);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(255, 215, 0, 0.25);
    }
    
    .hidden { 
      display: none;
      opacity: 0;
    }
    
    .container:not(.hidden) {
      animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .progress {
      height: 20px;
      border-radius: 12px;
      background: #333;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .progress-bar {
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      color: #000;
      font-weight: bold;
      border-radius: 12px;
    }
    
    .profile-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }
    
    .cover-img {
      border-radius: 20px;
      height: 180px;
      object-fit: cover;
      filter: brightness(0.7);
    }
    
    .form-control, .form-select {
      background-color: rgba(0,0,0,0.5);
      border: 1px solid #333;
      color: var(--primary-color);
      padding: 12px 15px;
      border-radius: 12px;
    }
    
    .form-control:focus, .form-select:focus {
      background-color: rgba(0,0,0,0.7);
      border-color: var(--primary-color);
      color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
    }
    
    .table-dark {
      --bs-table-bg: transparent;
      --bs-table-striped-bg: rgba(255, 215, 0, 0.05);
      --bs-table-hover-bg: rgba(255, 215, 0, 0.1);
    }
    
    .badge-gold {
      background: linear-gradient(135deg, #ffd700, #ffcc00);
      color: #000;
    }
    
    .badge-hot {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      color: white;
    }
    
    .floating-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
      animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .overlay-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      text-shadow: 0 3px 8px rgba(0,0,0,0.9);
      width: 90%;
    }
    
    /* Survey Page Styles */
    .survey-container {
      background: var(--dark-bg);
      border-radius: 20px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
    }
    
    .survey-card {
      background: var(--card-bg);
      border: none;
      border-radius: 20px;
      box-shadow: 0 6px 18px rgba(255, 215, 0, 0.15);
      transition: all 0.3s ease-in-out;
      overflow: hidden;
    }
    
    .survey-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(255, 215, 0, 0.25);
    }
    
    .survey-img {
      height: 160px;
      object-fit: cover;
      width: 100%;
      filter: brightness(0.8);
    }
    
    .survey-btn-warning {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: #000;
      font-weight: 500;
      border-radius: 12px;
      border: none;
      box-shadow: 0 3px 8px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .survey-btn-warning:hover {
      background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(255, 215, 0, 0.6);
    }
    
    .survey-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--primary-color);
      font-weight: 500;
      border-radius: 12px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .survey-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--primary-color);
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
    }
    
    .survey-card .card-body {
      padding: 15px;
      display: flex;
      flex-direction: column;
      height: calc(100% - 160px);
    }
    
    .survey-card .card-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .survey-card .card-text {
      color: rgba(255, 215, 0, 0.8);
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    
    .survey-card .btn-group {
      margin-top: auto;
    }
    
    /* Admin Panel Styles */
    .admin-panel {
      background: rgba(0,0,0,0.8);
      border-radius: 20px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid var(--primary-color);
    }
    
    .admin-btn {
      background: linear-gradient(135deg, #dc3545, #bb2d3b);
      color: white;
      font-weight: 500;
      border-radius: 12px;
      border: none;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    .admin-btn:hover {
      background: linear-gradient(135deg, #bb2d3b, #dc3545);
      color: white;
    }
    
    .user-list-item {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .user-list-item:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .banned-user {
      opacity: 0.6;
      background: rgba(255, 0, 0, 0.1);
      border-left: 3px solid red;
    }
    
    @media (max-width: 576px) {
      .cover-img {
        height: 150px;
      }
      
      .bottom-nav a {
        padding: 10px 12px;
        max-width: 64px;
      }
      
      .top-header {
        padding: 10px 15px;
      }
      
      .survey-img {
        height: 120px;
      }
      
      .survey-card .card-body {
        height: calc(100% - 120px);
      }
    }
  </style>
</head>
<body>

<!-- TOP HEADER -->
<div class="top-header d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-2">
    <img id="profileImage" src="https://via.placeholder.com/50" class="profile-img rounded-circle shadow" alt="Logo">
    <h5 class="m-0 fw-bold">Money Land</h5>
  </div>
  <div class="text-end">
    <div class="d-flex align-items-center justify-content-end gap-2">
      <i class="bi bi-wallet2"></i>
      <span id="balance" class="fw-bold">0.00</span> 
      <span class="badge badge-gold">BDT</span>
    </div>
  </div>
</div>

<!-- NOTIFICATION AREA -->
<div id="notificationArea"></div>

<!-- VPN CHECK MODAL -->
<div class="modal fade" id="vpnModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title">Connection Check</h5>
      </div>
      <div class="modal-body text-center py-4">
        <div id="vpnStatus" class="alert alert-info">Checking your connection...</div>
        <div id="vpnAlert" class="alert alert-warning d-none">🚨 VPN required! Please connect VPN.</div>
        <div id="vpnOffAlert" class="alert alert-danger d-none">⚠️ VPN detected! Please turn it off.</div>
        <div id="vpnSuccess" class="alert alert-success d-none">✅ VPN check passed! Loading app...</div>
      </div>
    </div>
  </div>
</div>

<!-- HOME -->
<div id="home" class="container my-4">
  <div class="position-relative mb-4 mt-2">
    <img id="coverImage" src="https://via.placeholder.com/1200x400" class="img-fluid cover-img shadow-lg w-100" alt="Cover">
    <div class="overlay-text">
      <h5>Welcome back, <span id="username" class="text-warning">User</span></h5>
      <h2 class="fw-bold mb-3">Start Earning Today</h2>
      <button class="btn btn-custom px-4 py-2">Let's Earn <i class="bi bi-arrow-right ms-2"></i></button>
    </div>
  </div>
  
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <i class="bi bi-cash-coin fs-1 mb-2 text-warning"></i>
        <h5>Total Earnings</h5>
        <h3 class="fw-bold"><span id="totalEarnings">0.00</span> <small class="fs-6">BDT</small></h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <i class="bi bi-check-circle fs-1 mb-2 text-success"></i>
        <h5>Tasks Done</h5>
        <h3 class="fw-bold"><span id="completed">0</span>/<span id="dailyLimit">60</span></h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <i class="bi bi-people fs-1 mb-2 text-info"></i>
        <h5>Referrals</h5>
        <h3 class="fw-bold"><span id="referralCount">0</span></h3>
      </div>
    </div>
  </div>
</div>

<!-- REWARDS -->
<div id="rewards" class="container my-4 hidden">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="m-0">Earning Rewards</h3>
    <span class="badge badge-hot px-3 py-2">Hot Offers</span>
  </div>
  
  <div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h5 class="mb-1">Daily Tasks Progress</h5>
        <small class="text-muted">Complete tasks to earn more</small>
      </div>
      <span class="badge bg-dark px-3 py-2"><span id="remaining">60</span> remaining</span>
    </div>
    
    <div class="progress mb-4">
      <div id="progressBar" class="progress-bar" style="width:0%">0%</div>
    </div>
    
    <button class="btn btn-custom w-100 mb-3 py-3" onclick="watchAd()">
      <i class="bi bi-play-circle me-2"></i> Watch Ad (+<span id="adReward">0.20</span> BDT)
    </button>
    
    <div class="alert alert-dark d-flex align-items-center" role="alert">
      <i class="bi bi-info-circle-fill me-2"></i>
      <small>Complete all <span id="dailyLimit2">60</span> tasks to unlock bonus rewards</small>
    </div>
  </div>
  
  <h4 class="mb-3">Daily Offers</h4>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-star-fill text-warning me-2"></i>
          <h5 class="m-0">Survey Task</h5>
        </div>
        <p class="text-muted small mb-3">Complete surveys and earn up to <span id="surveyReward">5.00</span> BDT per survey</p>
        <button onclick="showSurveyPage()" class="btn btn-outline-warning w-100 mt-auto">Start Survey</button>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-gem text-info me-2"></i>
          <h5 class="m-0">Refer Friends</h5>
        </div>
        <p class="text-muted small mb-3">Earn <span id="referralPercent">10</span>% of your referrals' earnings</p>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="inviteLink" value="Loading..." readonly>
          <button class="btn btn-outline-info w-20" type="button" onclick="copyInviteLink()">Copy</button>
        </div>   
      </div>    
    </div>
  </div>
</div>

<!-- WITHDRAW -->
<div id="withdraw" class="container my-4 hidden">
  <h3 class="mb-4">Withdraw Funds</h3>
  
  <div class="card p-4 mb-4">
    <h5 class="mb-3 fw-bold"><i class="bi bi-wallet2 me-2"></i> Withdrawal Options</h5>
    
    <div class="mb-3">
      <label class="fw-bold mb-2">Withdrawal Method</label>
      <select class="form-select mb-3" id="method">
        <option value="">Select a method</option>
        <option>Bkash</option>
        <option>Nagad</option>
        <option>Binance Id</option>
      </select>
    </div>
    
    <div class="mb-3">
      <label class="fw-bold mb-2">Amount (BDT)</label>
      <input type="number" class="form-control mb-3" id="amount" placeholder="Enter amount">
      <div class="d-flex justify-content-between small text-white">
        <span>Min: <span id="minWithdraw">50</span> BDT</span>
        <span>Available: <span id="availableBalance">0.00</span> BDT</span>
      </div>
    </div>
    
    <div class="mb-4">
      <label class="fw-bold mb-2">Wallet/Account Number</label>
      <input type="text" class="form-control" id="address" placeholder="Enter your wallet number">
    </div>
    
    <button class="btn btn-custom w-100 py-3" onclick="withdraw()">
      <i class="bi bi-send-check me-2"></i> Submit Withdrawal
    </button>
  </div>
  
  <div class="card p-4">
    <h5 class="mb-3 fw-bold"><i class="bi bi-info-circle me-2"></i> Withdrawal Info</h5>
    <ul class="list-unstyled">
      <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i> Minimum withdrawal: <span id="minWithdraw2">50</span> BDT</li>
      <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i> Processing time: 24-48 hours</li>
      <li><i class="bi bi-check-circle text-success me-2"></i> <span id="withdrawFee">5</span>৳ fees</li>
    </ul>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="container my-4 hidden">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="m-0">Transaction History</h3>
    <div class="dropdown">
      <button class="btn btn-dark dropdown-toggle" type="button" id="historyFilter" data-bs-toggle="dropdown">
        <i class="bi bi-funnel"></i> Filter
      </button>
      <ul class="dropdown-menu dropdown-menu-dark">
        <li><a class="dropdown-item active" href="#" onclick="filterHistory('all')">All</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterHistory('withdrawal')">Withdrawals</a></li>
        <li><a class="dropdown-item" href="#" onclick="filterHistory('earning')">Earnings</a></li>
      </ul>
    </div>
  </div>
  
  <div class="card p-0 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-dark table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th class="ps-4 text-nowrap">Date</th>
            <th>Method</th>
            <th class="">Amount</th>
            <th>Address</th>
            <th class="text-end pe-4 text-nowrap">Status</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          <!-- Data will be inserted here -->
        </tbody>
      </table>
    </div>
    
    <div class="card-footer bg-dark text-center py-3">
      <button class="btn btn-sm btn-outline-warning" onclick="loadMoreHistory()">
        <i class="bi bi-arrow-down"></i> Load More
      </button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div id="profile" class="container my-4 hidden">
  <div class="text-center mb-4">
    <img id="profileImageLarge" src="https://via.placeholder.com/120" class="rounded-circle border border-warning mb-3 shadow" width="120" height="120">
    <h3 class="fw-bold mb-1" id="profileUsername">User</h3>
    <p class="text-muted" id="profileTelegram">@telegram</p>
  </div>
  
  <div class="card p-4 mb-4 rounded-4 shadow-sm border-0">
    <h5 class="mb-3 fw-bold d-flex align-items-center">
      <i class="bi bi-person-badge me-2 text-warning"></i> Account Info
    </h5>

    <div class="row row-cols-2 g-3">
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Username</label>
          <span id="profileUsername2">user123</span>
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Member Since</label>
          <span id="joinDate">Jan 2024</span>
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Promo Code</label>
          <span id="referralCode">MONEY123</span>
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Referrals</label>
          <span id="referralCount2">5</span> users
        </div>
      </div>
    </div>
  </div>

  <div class="card p-4 mb-4 rounded-4 shadow-sm border-0">
    <h5 class="mb-3 fw-bold d-flex align-items-center">
      <i class="bi bi-graph-up me-2"></i> Earnings Summary
    </h5>

    <div class="row row-cols-2 g-3">
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Total Earnings</label>
          <span id="totalEarnings2">100.00</span> BDT
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Withdrawn</label>
          <span id="totalWithdrawn">0.00</span> BDT
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Available Balance</label>
          <span id="availableBalance2">100.00</span> BDT
        </div>
      </div>
      <div class="col">
        <div class="p-3 rounded-3 fw-bold text-dark shadow-sm bg-warning bg-gradient hover-shadow">
          <label class="small text-muted d-block mb-1">Referral Earnings</label>
          <span id="referralEarnings">0.00</span> BDT
        </div>
      </div>
    </div>
  </div>
  
  <!-- Admin Panel (only visible to admins) -->
  <div id="adminPanel" class="admin-panel hidden">
    <h4 class="text-center mb-4"><i class="bi bi-shield-lock"></i> Admin Panel</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card p-3">
          <h5><i class="bi bi-gear"></i> App Settings</h5>
          <div class="mb-3">
            <label class="form-label">Daily Task Limit</label>
            <input type="number" id="dailyLimitInput" class="form-control" value="60">
          </div>
          <div class="mb-3">
            <label class="form-label">Ad Reward (BDT)</label>
            <input type="number" step="0.01" id="adRewardInput" class="form-control" value="0.20">
          </div>
          <div class="mb-3">
            <label class="form-label">Survey Reward (BDT)</label>
            <input type="number" step="0.01" id="surveyRewardInput" class="form-control" value="0.30">
          </div>
          <div class="mb-3">
            <label class="form-label">Min Withdrawal (BDT)</label>
            <input type="number" id="minWithdrawInput" class="form-control" value="50">
          </div>
          <button class="btn btn-success w-100" onclick="updateAppSettings()">Update Settings</button>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <h5><i class="bi bi-image"></i> Change Images</h5>
          <div class="mb-3">
            <label class="form-label">Home Cover Image URL</label>
            <input type="text" id="coverImageInput" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Default Profile Image URL</label>
            <input type="text" id="profileImageInput" class="form-control">
          </div>
          <button class="btn btn-info w-100 mb-3" onclick="updateImages()">Update Images</button>
          
          <h5 class="mt-3"><i class="bi bi-people"></i> User Management</h5>
          <button class="btn btn-primary w-100 mb-2" onclick="showAllUsers()">View All Users</button>
          <button class="btn btn-warning w-100" onclick="showWithdrawalRequests()">Withdrawal Requests</button>
        </div>
      </div>
    </div>
    
    <!-- All Users List -->
    <div id="allUsersList" class="card p-3 mt-3 hidden">
      <h5 class="mb-3"><i class="bi bi-people-fill"></i> All Users</h5>
      <div class="table-responsive">
        <table class="table table-dark table-hover">
          <thead>
            <tr>
              <th>Username</th>
              <th>Balance</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Withdrawal Requests -->
    <div id="withdrawalRequests" class="card p-3 mt-3 hidden">
      <h5 class="mb-3"><i class="bi bi-cash-stack"></i> Withdrawal Requests</h5>
      <div class="table-responsive">
        <table class="table table-dark table-hover">
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Wallet</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalTableBody">
            <!-- Withdrawals will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- SURVEY PAGE (hidden by default) -->
<div id="surveyPage" class="container survey-container hidden">
  <h3 class="mb-4 fw-bold text-center">✨ Available Surveys</h3>
  <div class="row g-4" id="surveysContainer">
    <!-- Surveys will be loaded dynamically -->
  </div>
  
  <div class="text-center mt-4">
    <button class="btn btn-outline-warning" onclick="hideSurveyPage()">
      <i class="bi bi-arrow-left"></i> Back to Rewards
    </button>
  </div>
</div>

<!-- PERFECT BOTTOM NAVIGATION -->
<div class="bottom-nav shadow-lg">
  <a href="#" onclick="showTab('home', this)" class="active">
    <i class="bi bi-house"></i>
    <span>Home</span>
  </a>
  <a href="#" onclick="showTab('rewards', this)">
    <i class="bi bi-cash-coin"></i>
    <span>Earn</span>
  </a>
  <a href="#" onclick="showTab('withdraw', this)">
    <i class="bi bi-wallet2"></i>
    <span>Withdraw</span>
  </a>
  <a href="#" onclick="showTab('history', this)">
    <i class="bi bi-clock-history"></i>
    <span>History</span>
  </a>
  <a href="#" onclick="showTab('profile', this)">
    <i class="bi bi-person"></i>
    <span>Profile</span>
  </a>
</div>

<!-- Firebase and Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Firebase configuration
  const firebaseConfig = {
      apiKey: "AIzaSyC9Nmbyu4FgW66GNaL8EpfuFxgC1w6Diws",
      authDomain: "webl-5e410.firebaseapp.com",
      databaseURL: "https://webl-5e410-default-rtdb.firebaseio.com",
      projectId: "webl-5e410",
      storageBucket: "webl-5e410.appspot.com",
      messagingSenderId: "424058649578",
      appId: "1:424058649578:web:0c3b07b6f15764096d1093",
      measurementId: "G-H69CZMD0TH"
    };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();
  
  // Initialize Cloudinary
  const cl = cloudinary.Cloudinary.new({cloud_name: "dm2gi8k6n"});
  
  // Global variables
  let currentUser = null;
  let userData = null;
  let appSettings = {
    dailyLimit: 60,
    adReward: 0.20,
    surveyReward: 0.30,
    minWithdraw: 50,
    withdrawFee: 5,
    referralPercent: 10,
    coverImage: "https://via.placeholder.com/1200x400",
    profileImage: "https://via.placeholder.com/50",
    vpnRequired: true
  };
  
  let historyData = [];
  let surveys = [];
  let allUsers = [];
  let withdrawalRequests = [];
  
  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', async function() {
    // Initialize modal
    const vpnModal = new bootstrap.Modal(document.getElementById('vpnModal'));
    
    // Load app settings
    await loadAppSettings();
    
    // Check if user is logged in via Telegram
    const urlParams = new URLSearchParams(window.location.search);
    const tgUser = urlParams.get('tg_user');
    
    if (tgUser) {
      try {
        const tgData = JSON.parse(decodeURIComponent(tgUser));
        await handleTelegramLogin(tgData);
      } catch (e) {
        console.error("Error parsing Telegram user:", e);
        showNotification("Error", "Invalid Telegram login", "danger");
      }
    } else {
      // Show VPN check modal
      vpnModal.show();
      await checkIP();
    }
    
    // Load surveys
    await loadSurveys();
  });
  
  // Handle Telegram login
  async function handleTelegramLogin(tgData) {
    try {
      // Check if user exists
      const userRef = db.collection('users').doc(tgData.id.toString());
      const doc = await userRef.get();
      
      if (doc.exists) {
        // Existing user
        userData = doc.data();
        userData.id = doc.id;
        currentUser = tgData;
        
        // Check if banned
        if (userData.isBanned) {
          showNotification("Account Banned", "Your account has been suspended", "danger");
          return;
        }
        
        // Update last login
        await userRef.update({
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        // New user
        currentUser = tgData;
        userData = {
          id: tgData.id.toString(),
          username: tgData.username || `user${tgData.id.toString().slice(-4)}`,
          firstName: tgData.first_name,
          lastName: tgData.last_name || '',
          telegramUsername: tgData.username ? `@${tgData.username}` : 'N/A',
          balance: 0,
          totalEarnings: 0,
          totalWithdrawn: 0,
          referralEarnings: 0,
          referralCode: generateReferralCode(),
          referrals: [],
          tasksCompleted: 0,
          tasksCompletedToday: 0,
          lastTaskDate: null,
          isAdmin: false,
          isBanned: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Check for referral
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) {
          // Find referrer
          const query = await db.collection('users').where('referralCode', '==', refCode).limit(1).get();
          if (!query.empty) {
            const referrer = query.docs[0].data();
            referrer.id = query.docs[0].id;
            
            // Update referrer's data
            await db.collection('users').doc(referrer.id).update({
              referrals: firebase.firestore.FieldValue.arrayUnion(userData.id)
            });
            
            // Store referrer info
            userData.referredBy = referrer.id;
          }
        }
        
        // Create new user
        await userRef.set(userData);
      }
      
      // Load user data
      await loadUserData();
      
      // Update UI
      updateUI();
      
      // Hide VPN modal if shown
      const vpnModal = bootstrap.Modal.getInstance(document.getElementById('vpnModal'));
      if (vpnModal) vpnModal.hide();
      
    } catch (error) {
      console.error("Error handling Telegram login:", error);
      showNotification("Error", "Failed to login with Telegram", "danger");
    }
  }
  
  // Generate random referral code
  function generateReferralCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }
  
  // Load app settings from Firestore
  async function loadAppSettings() {
    try {
      const doc = await db.collection('appSettings').doc('settings').get();
      if (doc.exists) {
        appSettings = {...appSettings, ...doc.data()};
        
        // Update UI elements with settings
        document.getElementById('dailyLimit').textContent = appSettings.dailyLimit;
        document.getElementById('dailyLimit2').textContent = appSettings.dailyLimit;
        document.getElementById('adReward').textContent = appSettings.adReward.toFixed(2);
        document.getElementById('surveyReward').textContent = appSettings.surveyReward.toFixed(2);
        document.getElementById('minWithdraw').textContent = appSettings.minWithdraw;
        document.getElementById('minWithdraw2').textContent = appSettings.minWithdraw;
        document.getElementById('withdrawFee').textContent = appSettings.withdrawFee;
        document.getElementById('referralPercent').textContent = appSettings.referralPercent;
        
        // Set images
        document.getElementById('coverImage').src = appSettings.coverImage;
        document.getElementById('profileImage').src = appSettings.profileImage;
        document.getElementById('profileImageLarge').src = appSettings.profileImage;
        
        // Update inputs in admin panel
        document.getElementById('dailyLimitInput').value = appSettings.dailyLimit;
        document.getElementById('adRewardInput').value = appSettings.adReward;
        document.getElementById('surveyRewardInput').value = appSettings.surveyReward;
        document.getElementById('minWithdrawInput').value = appSettings.minWithdraw;
        document.getElementById('coverImageInput').value = appSettings.coverImage;
        document.getElementById('profileImageInput').value = appSettings.profileImage;
      }
    } catch (error) {
      console.error("Error loading app settings:", error);
    }
  }
  
  // Load user data from Firestore
  async function loadUserData() {
    try {
      const doc = await db.collection('users').doc(currentUser.id).get();
      if (doc.exists) {
        userData = doc.data();
        userData.id = doc.id;
        
        // Reset daily tasks if it's a new day
        const today = new Date().toDateString();
        const lastTaskDate = userData.lastTaskDate ? userData.lastTaskDate.toDate().toDateString() : null;
        
        if (lastTaskDate !== today) {
          await db.collection('users').doc(userData.id).update({
            tasksCompletedToday: 0,
            lastTaskDate: firebase.firestore.FieldValue.serverTimestamp()
          });
          userData.tasksCompletedToday = 0;
        }
        
        // Load transaction history
        await loadHistory();
        
        // Update invite link
        document.getElementById('inviteLink').value = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
        
        // Show admin panel if user is admin
        if (userData.isAdmin) {
          document.getElementById('adminPanel').classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error("Error loading user data:", error);
    }
  }
  
  // Load transaction history
  async function loadHistory(filter = 'all') {
    try {
      let query = db.collection('transactions')
        .where('userId', '==', currentUser.id)
        .orderBy('date', 'desc')
        .limit(10);
      
      if (filter === 'withdrawal') {
        query = query.where('type', '==', 'withdrawal');
      } else if (filter === 'earning') {
        query = query.where('type', '==', 'earning');
      }
      
      const snapshot = await query.get();
      historyData = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          method: data.method,
          amount: data.amount.toFixed(2),
          address: data.address || data.description,
          status: data.status,
          date: data.date.toDate().toLocaleDateString(),
          type: data.type
        };
      });
      
      updateHistoryTable();
    } catch (error) {
      console.error("Error loading history:", error);
    }
  }
  
  // Load surveys from Firestore
  async function loadSurveys() {
    try {
      const snapshot = await db.collection('surveys').where('isActive', '==', true).get();
      surveys = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          title: data.title,
          description: data.description,
          reward: data.reward,
          imageUrl: data.imageUrl,
          isActive: data.isActive
        };
      });
    } catch (error) {
      console.error("Error loading surveys:", error);
    }
  }
  
  // Load all users (admin only)
  async function showAllUsers() {
    try {
      document.getElementById('withdrawalRequests').classList.add('hidden');
      const listDiv = document.getElementById('allUsersList');
      listDiv.classList.remove('hidden');
      
      const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
      allUsers = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          username: data.username,
          telegramUsername: data.telegramUsername,
          balance: data.balance,
          isBanned: data.isBanned || false,
          isAdmin: data.isAdmin || false
        };
      });
      
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      
      allUsers.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = `user-list-item ${user.isBanned ? 'banned-user' : ''}`;
        tr.innerHTML = `
          <td>${user.username} <small class="text-muted">${user.telegramUsername}</small></td>
          <td>${user.balance.toFixed(2)} BDT</td>
          <td>
            ${user.isBanned ? '<span class="badge bg-danger">Banned</span>' : ''}
            ${user.isAdmin ? '<span class="badge bg-primary">Admin</span>' : ''}
          </td>
          <td>
            ${!user.isBanned ? 
              `<button class="btn btn-sm btn-danger" onclick="banUser('${user.id}')">Ban</button>` : 
              `<button class="btn btn-sm btn-success" onclick="unbanUser('${user.id}')">Unban</button>`}
            ${!user.isAdmin ? 
              `<button class="btn btn-sm btn-primary ms-1" onclick="makeAdmin('${user.id}')">Make Admin</button>` : 
              `<button class="btn btn-sm btn-secondary ms-1" onclick="removeAdmin('${user.id}')">Remove Admin</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Error loading users:", error);
    }
  }
  
  // Load withdrawal requests (admin only)
  async function showWithdrawalRequests() {
    try {
      document.getElementById('allUsersList').classList.add('hidden');
      const requestsDiv = document.getElementById('withdrawalRequests');
      requestsDiv.classList.remove('hidden');
      
      const snapshot = await db.collection('withdrawals')
        .where('status', '==', 'pending')
        .orderBy('requestDate', 'desc')
        .get();
      
      withdrawalRequests = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          userId: data.userId,
          amount: data.amount,
          method: data.method,
          wallet: data.wallet,
          status: data.status,
          requestDate: data.requestDate.toDate().toLocaleString()
        };
      });
      
      // Get user info for each withdrawal
      const userIds = withdrawalRequests.map(w => w.userId);
      const usersSnapshot = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', userIds).get();
      const users = {};
      usersSnapshot.forEach(doc => {
        users[doc.id] = doc.data();
      });
      
      const tbody = document.getElementById('withdrawalTableBody');
      tbody.innerHTML = '';
      
      withdrawalRequests.forEach(req => {
        const user = users[req.userId] || {username: 'Unknown', telegramUsername: 'N/A'};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.username} <small class="text-muted">${user.telegramUsername}</small></td>
          <td>${req.amount.toFixed(2)} BDT</td>
          <td>${req.method}</td>
          <td>${req.wallet}</td>
          <td><span class="badge bg-warning">Pending</span></td>
          <td>
            <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${req.id}')">Approve</button>
            <button class="btn btn-sm btn-danger ms-1" onclick="rejectWithdrawal('${req.id}')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Error loading withdrawal requests:", error);
    }
  }
  
  // Update UI with current data
  function updateUI() {
    if (!userData) return;
    
    // Format balance with commas
    const formattedBalance = userData.balance.toFixed(2);
    const formattedTotal = userData.totalEarnings.toFixed(2);
    const formattedWithdrawn = userData.totalWithdrawn.toFixed(2);
    const formattedReferral = userData.referralEarnings.toFixed(2);
    
    document.getElementById('balance').innerText = formattedBalance;
    document.getElementById('availableBalance').innerText = formattedBalance;
    document.getElementById('availableBalance2').innerText = formattedBalance;
    document.getElementById('totalEarnings').innerText = formattedTotal;
    document.getElementById('totalEarnings2').innerText = formattedTotal;
    document.getElementById('totalWithdrawn').innerText = formattedWithdrawn;
    document.getElementById('referralEarnings').innerText = formattedReferral;
    document.getElementById('completed').innerText = userData.tasksCompletedToday;
    document.getElementById('referralCount').innerText = userData.referrals.length;
    document.getElementById('referralCount2').innerText = userData.referrals.length;
    document.getElementById('remaining').innerText = appSettings.dailyLimit - userData.tasksCompletedToday;
    
    // User info
    document.getElementById('username').innerText = userData.username;
    document.getElementById('profileUsername').innerText = userData.username;
    document.getElementById('profileUsername2').innerText = userData.username;
    document.getElementById('profileTelegram').innerText = userData.telegramUsername;
    document.getElementById('referralCode').innerText = userData.referralCode;
    
    // Join date
    if (userData.createdAt) {
      const joinDate = userData.createdAt.toDate();
      document.getElementById('joinDate').innerText = joinDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
    }
    
    // Progress bar
    let percent = Math.round((userData.tasksCompletedToday / appSettings.dailyLimit) * 100);
    document.getElementById('progressBar').style.width = percent + "%";
    document.getElementById('progressBar').innerText = percent + "%";
  }
  
  // Update history table
  function updateHistoryTable() {
    let table = document.getElementById('historyTable');
    table.innerHTML = "";
    
    historyData.slice(0, 5).forEach(tx => {
      let statusClass = "";
      if (tx.status === "pending") statusClass = "text-warning";
      if (tx.status === "completed") statusClass = "text-success";
      if (tx.status === "failed") statusClass = "text-danger";
      
      let row = `
        <tr>
          <td class="ps-4">${tx.date || "Today"}</td>
          <td>${tx.method}</td>
          <td>${tx.amount} ৳</td>
          <td>${tx.address ? (tx.address.length > 10 ? tx.address.substring(0, 4) + '...' + tx.address.slice(-4) : tx.address) : 'N/A'}</td>
          <td class="text-end pe-4 ${statusClass}">${tx.status.charAt(0).toUpperCase() + tx.status.slice(1)}</td>
        </tr>
      `;
      table.innerHTML += row;
    });
  }
  
  // Show tab function
  function showTab(tab, el) {
    // Add fade-out effect to current tab
    const currentTab = document.querySelector(".container:not(.hidden)");
    if (currentTab) {
      currentTab.style.opacity = 0;
      setTimeout(() => {
        currentTab.classList.add("hidden");
        
        // Show new tab
        document.querySelectorAll("div.container").forEach(div => div.classList.add("hidden"));
        const newTab = document.getElementById(tab);
        newTab.classList.remove("hidden");
        newTab.style.opacity = 1;
        
        // Update active nav item
        document.querySelectorAll(".bottom-nav a").forEach(a => a.classList.remove("active"));
        el.classList.add("active");
      }, 300);
    }
  }
  
  // Watch ad function
  async function watchAd() {
    if (!currentUser) return;
    
    // Check daily limit
    if (userData.tasksCompletedToday >= appSettings.dailyLimit) {
      showNotification("Completed!", "All tasks completed for today!", "info");
      return;
    }
    
    try {
      // Show ad and wait for completion
      await window.showGiga();
      
      // Update user balance and tasks
      const reward = appSettings.adReward;
      const newBalance = userData.balance + reward;
      const newTotal = userData.totalEarnings + reward;
      const newTasks = userData.tasksCompletedToday + 1;
      const newTotalTasks = userData.tasksCompleted + 1;
      
      // Update user data in Firestore
      await db.collection('users').doc(currentUser.id).update({
        balance: newBalance,
        totalEarnings: newTotal,
        tasksCompletedToday: newTasks,
        tasksCompleted: newTotalTasks,
        lastTaskDate: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Add transaction
      await db.collection('transactions').add({
        userId: currentUser.id,
        type: "earning",
        method: "Ad Watch",
        amount: reward,
        description: "Watched advertisement",
        status: "completed",
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update referral earnings if applicable
      if (userData.referredBy) {
        const referralBonus = reward * (appSettings.referralPercent / 100);
        await db.collection('users').doc(userData.referredBy).update({
          balance: firebase.firestore.FieldValue.increment(referralBonus),
          referralEarnings: firebase.firestore.FieldValue.increment(referralBonus),
          totalEarnings: firebase.firestore.FieldValue.increment(referralBonus)
        });
        
        // Add transaction for referrer
        await db.collection('transactions').add({
          userId: userData.referredBy,
          type: "earning",
          method: "Referral Bonus",
          amount: referralBonus,
          description: `Referral earnings from ${userData.username}`,
          status: "completed",
          date: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      // Update local data
      userData.balance = newBalance;
      userData.totalEarnings = newTotal;
      userData.tasksCompletedToday = newTasks;
      userData.tasksCompleted = newTotalTasks;
      
      // Update UI
      updateUI();
      await loadHistory();
      
      showNotification("Success!", `You earned ${reward.toFixed(2)} BDT!`, "success");
      
    } catch (e) {
      console.log("Ad failed or closed before completion", e);
      showNotification("Error", "Ad not completed. Please try again.", "danger");
    }
  }
  
  // Show survey page
  function showSurveyPage() {
    document.querySelectorAll("div.container").forEach(div => div.classList.add("hidden"));
    
    // Populate surveys
    const container = document.getElementById('surveysContainer');
    container.innerHTML = '';
    
    surveys.forEach((survey, index) => {
      const col = document.createElement('div');
      col.className = 'col-6';
      col.innerHTML = `
        <div class="card survey-card h-100">
          <img src="${survey.imageUrl || appSettings.profileImage}" class="survey-img" alt="${survey.title}">
          <div class="card-body">
            <h5 class="card-title">${survey.title}</h5>
            <p class="card-text text-success">Reward: BDT ${survey.reward.toFixed(2)}</p>
            <div class="d-flex gap-2 mt-auto">
              <button class="btn survey-btn-secondary flex-fill">Details</button>
              <button class="btn survey-btn-warning flex-fill" onclick="completeSurvey(${survey.reward}, '${survey.id}', '${survey.title}')">Claim</button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(col);
    });
    
    document.getElementById("surveyPage").classList.remove("hidden");
    document.querySelectorAll(".bottom-nav a").forEach(a => a.classList.remove("active"));
  }
  
  // Hide survey page
  function hideSurveyPage() {
    document.getElementById("surveyPage").classList.add("hidden");
    document.getElementById("rewards").classList.remove("hidden");
    document.querySelector('.bottom-nav a[onclick*="rewards"]').classList.add("active");
  }
  
  // Complete survey
  async function completeSurvey(reward, surveyId, surveyTitle) {
    if (!currentUser) return;
    
    // Check daily limit
    if (userData.tasksCompletedToday >= appSettings.dailyLimit) {
      showNotification("Completed!", "All tasks completed for today!", "info");
      return;
    }
    
    try {
      // Update user balance and tasks
      const newBalance = userData.balance + reward;
      const newTotal = userData.totalEarnings + reward;
      const newTasks = userData.tasksCompletedToday + 1;
      const newTotalTasks = userData.tasksCompleted + 1;
      
      // Update user data in Firestore
      await db.collection('users').doc(currentUser.id).update({
        balance: newBalance,
        totalEarnings: newTotal,
        tasksCompletedToday: newTasks,
        tasksCompleted: newTotalTasks,
        lastTaskDate: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Add transaction
      await db.collection('transactions').add({
        userId: currentUser.id,
        type: "earning",
        method: "Survey",
        amount: reward,
        description: surveyTitle,
        status: "completed",
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update referral earnings if applicable
      if (userData.referredBy) {
        const referralBonus = reward * (appSettings.referralPercent / 100);
        await db.collection('users').doc(userData.referredBy).update({
          balance: firebase.firestore.FieldValue.increment(referralBonus),
          referralEarnings: firebase.firestore.FieldValue.increment(referralBonus),
          totalEarnings: firebase.firestore.FieldValue.increment(referralBonus)
        });
        
        // Add transaction for referrer
        await db.collection('transactions').add({
          userId: userData.referredBy,
          type: "earning",
          method: "Referral Bonus",
          amount: referralBonus,
          description: `Referral earnings from ${userData.username}`,
          status: "completed",
          date: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      // Update local data
      userData.balance = newBalance;
      userData.totalEarnings = newTotal;
      userData.tasksCompletedToday = newTasks;
      userData.tasksCompleted = newTotalTasks;
      
      // Update UI
      updateUI();
      await loadHistory();
      
      showNotification("Success!", `You earned ${reward.toFixed(2)} BDT from survey!`, "success");
      
      // Hide survey page
      hideSurveyPage();
      
    } catch (error) {
      console.error("Error completing survey:", error);
      showNotification("Error", "Failed to complete survey", "danger");
    }
  }
  
  // Withdraw funds
  async function withdraw() {
    if (!currentUser) return;
    
    let method = document.getElementById("method").value;
    let amount = parseFloat(document.getElementById("amount").value);
    let address = document.getElementById("address").value;

    if (!method || !amount || !address) {
      return showNotification("Error", "Please fill all fields!", "danger");
    }
    
    if (amount < appSettings.minWithdraw) {
      return showNotification("Error", `Minimum withdrawal is ${appSettings.minWithdraw} BDT!`, "danger");
    }
    
    if (amount > userData.balance) {
      return showNotification("Error", "Not enough balance!", "danger");
    }

    try {
      // Calculate amount after fee
      const amountAfterFee = amount - appSettings.withdrawFee;
      
      // Create withdrawal request
      const withdrawalRef = await db.collection('withdrawals').add({
        userId: currentUser.id,
        username: userData.username,
        telegramUsername: userData.telegramUsername,
        method: method,
        amount: amount,
        amountAfterFee: amountAfterFee,
        wallet: address,
        status: "pending",
        requestDate: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update user balance
      await db.collection('users').doc(currentUser.id).update({
        balance: firebase.firestore.FieldValue.increment(-amount)
      });
      
      // Add transaction
      await db.collection('transactions').add({
        userId: currentUser.id,
        type: "withdrawal",
        method: method,
        amount: -amount,
        address: address,
        status: "pending",
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update local data
      userData.balance -= amount;
      
      // Update UI
      updateUI();
      await loadHistory();
      
      showNotification("Success!", "Withdrawal request submitted!", "success");
      
      // Clear form
      document.getElementById("method").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("address").value = "";
      
    } catch (error) {
      console.error("Error processing withdrawal:", error);
      showNotification("Error", "Failed to process withdrawal", "danger");
    }
  }
  
  // Copy invite link
  function copyInviteLink() {
    const copyText = document.getElementById("inviteLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999); // For mobile devices
    navigator.clipboard.writeText(copyText.value)
      .then(() => {
        showNotification("Copied!", "Invite link copied to clipboard", "success");
      })
      .catch(err => {
        console.error("Failed to copy: ", err);
        showNotification("Error", "Failed to copy link", "danger");
      });
  }
  
  // Filter history
  function filterHistory(type) {
    loadHistory(type);
    
    // Update dropdown text
    const dropdown = document.querySelector('.dropdown-toggle');
    if (type === 'all') dropdown.innerHTML = '<i class="bi bi-funnel"></i> All';
    else if (type === 'withdrawal') dropdown.innerHTML = '<i class="bi bi-funnel"></i> Withdrawals';
    else if (type === 'earning') dropdown.innerHTML = '<i class="bi bi-funnel"></i> Earnings';
  }
  
  // Load more history
  async function loadMoreHistory() {
    showNotification("Info", "Loading more transactions...", "info");
    // Implement pagination here if needed
  }
  
  // Show notification
  function showNotification(title, message, type) {
    const notification = document.createElement("div");
    notification.className = `alert alert-${type} floating-notification alert-dismissible shadow`;
    notification.innerHTML = `
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      <strong>${title}</strong> ${message}
    `;
    
    document.getElementById("notificationArea").appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      notification.classList.add("fade");
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }
  
  // VPN check function
  async function checkIP() {
    try {
      // Hide previous alerts
      document.getElementById("vpnAlert").classList.add("d-none");
      document.getElementById("vpnOffAlert").classList.add("d-none");
      document.getElementById("vpnSuccess").classList.add("d-none");
      
      // Show checking status
      document.getElementById("vpnStatus").textContent = "Checking your connection...";
      
      // Step 1: Get public IP
      let ipRes = await fetch("https://api64.ipify.org?format=json");
      let ipData = await ipRes.json();
      
      // Step 2: Get IP details
      let geoRes = await fetch(`https://ipapi.co/${ipData.ip}/json/`);
      let geoData = await geoRes.json();
      
      document.getElementById("vpnStatus").textContent = `Your country: ${geoData.country_name}`;
      
      if(appSettings.vpnRequired) {
        // Admin toggle ON → VPN enforce
        if(geoData.country === "BD") {
          document.getElementById("vpnAlert").classList.remove("d-none");
        } else {
          document.getElementById("vpnSuccess").classList.remove("d-none");
          setTimeout(() => {
            const vpnModal = bootstrap.Modal.getInstance(document.getElementById('vpnModal'));
            if (vpnModal) vpnModal.hide();
          }, 2000);
        }
      } else {
        // Admin toggle OFF → VPN enforcement off
        if(geoData.country !== "BD") {
          // Non-BD user using VPN → warning
          document.getElementById("vpnOffAlert").classList.remove("d-none");
        } else {
          // BD users → show success
          document.getElementById("vpnSuccess").classList.remove("d-none");
          setTimeout(() => {
            const vpnModal = bootstrap.Modal.getInstance(document.getElementById('vpnModal'));
            if (vpnModal) vpnModal.hide();
          }, 2000);
        }
      }
      
    } catch (e) {
      document.getElementById("vpnStatus").textContent = "Failed to check IP (API error)";
      console.error("VPN check error:", e);
      
      // If API fails, allow access but warn user
      document.getElementById("vpnSuccess").classList.remove("d-none");
      setTimeout(() => {
        const vpnModal = bootstrap.Modal.getInstance(document.getElementById('vpnModal'));
        if (vpnModal) vpnModal.hide();
      }, 2000);
    }
  }
  
  /* ADMIN FUNCTIONS */
  
  // Update app settings
  async function updateAppSettings() {
    try {
      const newSettings = {
        dailyLimit: parseInt(document.getElementById('dailyLimitInput').value) || 60,
        adReward: parseFloat(document.getElementById('adRewardInput').value) || 0.20,
        surveyReward: parseFloat(document.getElementById('surveyRewardInput').value) || 0.30,
        minWithdraw: parseInt(document.getElementById('minWithdrawInput').value) || 50,
        vpnRequired: appSettings.vpnRequired // Keep existing value
      };
      
      await db.collection('appSettings').doc('settings').set(newSettings, { merge: true });
      
      // Update local settings
      appSettings = { ...appSettings, ...newSettings };
      
      // Update UI
      document.getElementById('dailyLimit').textContent = appSettings.dailyLimit;
      document.getElementById('dailyLimit2').textContent = appSettings.dailyLimit;
      document.getElementById('adReward').textContent = appSettings.adReward.toFixed(2);
      document.getElementById('surveyReward').textContent = appSettings.surveyReward.toFixed(2);
      document.getElementById('minWithdraw').textContent = appSettings.minWithdraw;
      document.getElementById('minWithdraw2').textContent = appSettings.minWithdraw;
      
      showNotification("Success", "App settings updated!", "success");
    } catch (error) {
      console.error("Error updating settings:", error);
      showNotification("Error", "Failed to update settings", "danger");
    }
  }
  
  // Update images
  async function updateImages() {
    try {
      const coverImage = document.getElementById('coverImageInput').value;
      const profileImage = document.getElementById('profileImageInput').value;
      
      if (!coverImage || !profileImage) {
        return showNotification("Error", "Please enter valid image URLs", "danger");
      }
      
      await db.collection('appSettings').doc('settings').set({
        coverImage: coverImage,
        profileImage: profileImage
      }, { merge: true });
      
      // Update local settings
      appSettings.coverImage = coverImage;
      appSettings.profileImage = profileImage;
      
      // Update UI images
      document.getElementById('coverImage').src = coverImage;
      document.getElementById('profileImage').src = profileImage;
      document.getElementById('profileImageLarge').src = profileImage;
      
      showNotification("Success", "Images updated!", "success");
    } catch (error) {
      console.error("Error updating images:", error);
      showNotification("Error", "Failed to update images", "danger");
    }
  }
  
  // Ban user
  async function banUser(userId) {
    if (!confirm("Are you sure you want to ban this user?")) return;
    
    try {
      await db.collection('users').doc(userId).update({
        isBanned: true
      });
      
      showNotification("Success", "User banned successfully", "success");
      showAllUsers(); // Refresh list
    } catch (error) {
      console.error("Error banning user:", error);
      showNotification("Error", "Failed to ban user", "danger");
    }
  }
  
  // Unban user
  async function unbanUser(userId) {
    try {
      await db.collection('users').doc(userId).update({
        isBanned: false
      });
      
      showNotification("Success", "User unbanned successfully", "success");
      showAllUsers(); // Refresh list
    } catch (error) {
      console.error("Error unbanning user:", error);
      showNotification("Error", "Failed to unban user", "danger");
    }
  }
  
  // Make admin
  async function makeAdmin(userId) {
    if (!confirm("Are you sure you want to make this user an admin?")) return;
    
    try {
      await db.collection('users').doc(userId).update({
        isAdmin: true
      });
      
      showNotification("Success", "User is now an admin", "success");
      showAllUsers(); // Refresh list
    } catch (error) {
      console.error("Error making admin:", error);
      showNotification("Error", "Failed to make user admin", "danger");
    }
  }
  
  // Remove admin
  async function removeAdmin(userId) {
    if (!confirm("Are you sure you want to remove admin privileges from this user?")) return;
    
    try {
      await db.collection('users').doc(userId).update({
        isAdmin: false
      });
      
      showNotification("Success", "Admin privileges removed", "success");
      showAllUsers(); // Refresh list
    } catch (error) {
      console.error("Error removing admin:", error);
      showNotification("Error", "Failed to remove admin", "danger");
    }
  }
  
  // Approve withdrawal
  async function approveWithdrawal(withdrawalId) {
    if (!confirm("Approve this withdrawal request?")) return;
    
    try {
      // Get withdrawal data
      const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
      if (!withdrawalDoc.exists) return;
      
      const withdrawal = withdrawalDoc.data();
      
      // Update withdrawal status
      await db.collection('withdrawals').doc(withdrawalId).update({
        status: "completed",
        processDate: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update user's total withdrawn
      await db.collection('users').doc(withdrawal.userId).update({
        totalWithdrawn: firebase.firestore.FieldValue.increment(withdrawal.amountAfterFee)
      });
      
      // Update transaction status
      const transactions = await db.collection('transactions')
        .where('userId', '==', withdrawal.userId)
        .where('type', '==', 'withdrawal')
        .where('amount', '==', -withdrawal.amount)
        .where('status', '==', 'pending')
        .limit(1)
        .get();
      
      if (!transactions.empty) {
        await db.collection('transactions').doc(transactions.docs[0].id).update({
          status: "completed"
        });
      }
      
      showNotification("Success", "Withdrawal approved", "success");
      showWithdrawalRequests(); // Refresh list
    } catch (error) {
      console.error("Error approving withdrawal:", error);
      showNotification("Error", "Failed to approve withdrawal", "danger");
    }
  }
  
  // Reject withdrawal
  async function rejectWithdrawal(withdrawalId) {
    if (!confirm("Reject this withdrawal request and return funds to user?")) return;
    
    try {
      // Get withdrawal data
      const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
      if (!withdrawalDoc.exists) return;
      
      const withdrawal = withdrawalDoc.data();
      
      // Return funds to user
      await db.collection('users').doc(withdrawal.userId).update({
        balance: firebase.firestore.FieldValue.increment(withdrawal.amount)
      });
      
      // Update withdrawal status
      await db.collection('withdrawals').doc(withdrawalId).update({
        status: "rejected",
        processDate: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update transaction status
      const transactions = await db.collection('transactions')
        .where('userId', '==', withdrawal.userId)
        .where('type', '==', 'withdrawal')
        .where('amount', '==', -withdrawal.amount)
        .where('status', '==', 'pending')
        .limit(1)
        .get();
      
      if (!transactions.empty) {
        await db.collection('transactions').doc(transactions.docs[0].id).update({
          status: "rejected"
        });
      }
      
      showNotification("Success", "Withdrawal rejected and funds returned", "success");
      showWithdrawalRequests(); // Refresh list
    } catch (error) {
      console.error("Error rejecting withdrawal:", error);
      showNotification("Error", "Failed to reject withdrawal", "danger");
    }
  }
</script>
</body>
</html>
